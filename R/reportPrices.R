#' Read in GDX and calculate prices, used in convGDX2MIF.R for the reporting
#'
#' Read in price information from GDX file, information used in convGDX2MIF.R
#' for the reporting
#'
#'
#' @param gdx a GDX object as created by readGDX, or the path to a gdx
#' @param output a magpie object containing all needed variables generated by other report*.R functions
#' @param regionSubsetList a list containing regions to create report variables region
#' aggregations. If NULL (default value) only the global region aggregation "GLO" will
#' be created.
#' @param t temporal resolution of the reporting, default:
#' t=c(seq(2005,2060,5),seq(2070,2110,10),2130,2150)
#'
#' @return MAgPIE object - contains the price variables
#' @importFrom luscale speed_aggregate
#' @author Alois Dirnaichner, Felix Schreyer, David Klein
#' @seealso \code{\link{convGDX2MIF}}
#' @examples
#'
#' \dontrun{reportPrices(gdx)}
#'
#' @importFrom dplyr %>% case_when distinct filter inner_join tibble
#' @importFrom gdx readGDX
#' @importFrom luscale speed_aggregate
#' @importFrom magclass mbind getYears getRegions setNames dimSums new.magpie lowpass complete_magpie getItems<-
#' @importFrom quitte df.2.named.vector getColValues
#' @importFrom readr read_csv
#' @importFrom madrat toolAggregate
#'

#' @export
reportPrices <- function(gdx, output=NULL, regionSubsetList=NULL,
                         t=c(seq(2005,2060,5),seq(2070,2110,10),2130,2150)) {

  ####### get realisations #########
  realisation <- readGDX(gdx, "module2realisation")

  ####### conversion factors ##########
  s_GWP_CH4 <- readGDX(gdx,c("sm_gwpCH4","s_gwpCH4","s_GWP_CH4"),format="first_found", react = "silent")
  s_GWP_N2O <- readGDX(gdx,c("s_gwpN2O","s_GWP_N2O"),format="first_found", react = "silent")
  tdptwyr2dpgj <- 31.71   #TerraDollar per TWyear to Dollar per GJ
  p80_subset   <- c("perm","good","peur","peoil","pegas","pecoal","pebiolc") #TODO: read in from gdx as sets trade
  ####### read in needed data #########

  #---- Functions
  find_real_module <- function(module_set, module_name){
    return(module_set[module_set$modules == module_name,2])
  }

  indu_mod = find_real_module(realisation,"industry")

  ## parameter
  shift_p        <- readGDX(gdx,name="p30_pebiolc_pricshift",format="first_found")[, t,]
  mult_p         <- readGDX(gdx,name="p30_pebiolc_pricmult",format="first_found")[, t,]
  pric_mag       <- readGDX(gdx,name="p30_pebiolc_pricemag",format="first_found")[, t,]
  pric_emu_pre   <- readGDX(gdx,name="p30_pebiolc_price_emu_preloop",format="first_found")[, t,]
  pric_emu_pre_shifted <- readGDX(gdx,name="p30_pebiolc_price_emu_preloop_shifted",format="first_found")[, t,]
  bio_tax_factor <- readGDX(gdx,name="p21_tau_bioenergy_tax",format="first_found")[, t,]
  pm_pvp        <- readGDX(gdx,name=c("pm_pvp","p80_pvp"),format="first_found")[, t, p80_subset]
  pm_dataemi     <- readGDX(gdx,name=c("pm_emifac","pm_dataemi"),format="first_found",restore_zeros=FALSE)[,t, c("pegas.seel.ngt.co2","pecoal.seel.pc.co2")]
  pm_pvpRegi     <- readGDX(gdx,name='pm_pvpRegi',format="first_found")[, t, "perm"]
  pm_taxCO2eq    <- readGDX(gdx,name=c("pm_taxCO2eq","pm_tau_CO2_tax"),format="first_found")[, t,]
  pm_taxCO2eqSCC     <- readGDX(gdx,name='pm_taxCO2eqSCC',format="first_found")[, t,]
  pm_taxemiMkt <- readGDX(gdx,name="pm_taxemiMkt",format="first_found")[, t,]
  ## variables
  pric_emu       <- readGDX(gdx,name="vm_pebiolc_price",field="l",format="first_found")[, t,]

  ## equations
  budget.m       <- readGDX(gdx,name='qm_budget',types = "equations",field = "m",format = "first_found")[, t,] # Alternative: calcPrice
  balcapture.m   <- readGDX(gdx,name=c("q_balcapture", "q12_balcapture"), field = "m", restore_zeros = F)[, t,]

  esm2macro.m    <- readGDX(gdx,name='q35_esm2macro',types="equations",field="m",format="first_found")[, t,]

  cm_emiscen     <- readGDX(gdx,name='cm_emiscen',format="first_found")

  q37_limit_secondary_steel_share.m <- readGDX(
    gdx, name = 'q37_limit_secondary_steel_share', types = 'equation',
    field = 'm', react = 'silent')[, t,]

  #####################################
  #choose the CES entries names for transport
  if (!is.null(esm2macro.m)) {
    name_trsp=c("fepet","ueLDVt","fedie","ueHDVt","feelt","ueelTt")
    name_trsp=name_trsp[name_trsp%in%getNames(esm2macro.m)]
  }
  #####################################

  ####### pm_pvp = EPS results in fantasy carbon prices

  for(yr in getYears(pm_pvp)){
    if(pm_pvp[,yr,"good"] == 0){
      pm_pvp[,yr,"good"] = 0.0001;
    }
  }

  module2realisation <- readGDX(gdx, "module2realisation")
  rownames(module2realisation) <- module2realisation$modules


  pm_FEPrice <- readGDX(gdx, "pm_FEPrice", restore_zeros = F)
  pm_SEPrice <- readGDX(gdx, "pm_SEPrice", restore_zeros = F)
  p_PEPrice <- readGDX(gdx, "p_PEPrice", restore_zeros = F)
  vm_demFeSector <- readGDX(gdx, "vm_demFeSector", field = "l", restore_zeros = F)[,t,]
  demSe          <- readGDX(gdx,name=c("vm_demSe","v_demSe"),
                            types="variables",field="l",format="first_found",
                            restore_zeros=FALSE)[,t,]

  ## weights for market aggregtion of prices: FE share of market
  p_weights_FEprice_mkt <- dimSums(vm_demFeSector, dim=3.1, na.rm = T) / dimSums(vm_demFeSector, dim=c(3.1,3.4), na.rm = T)
  p_weights_FEprice_mkt[is.na(p_weights_FEprice_mkt)] <- 0
  ## adjust to pm_FEprice dimensions
  p_weights_FEprice_mkt <- p_weights_FEprice_mkt[,getYears(pm_FEPrice),getNames(pm_FEPrice)]

  ## weights for fepet/fedie to liquids aggregtion of prices: FE fepet/fedie share of aggregated markets
  p_weights_FEprice_diepet <- dimSums(mselect(vm_demFeSector, all_enty1=c("fedie","fepet"), emi_sectors="trans"), dim=c(3.1,3.4), na.rm = T) /
    dimSums(mselect(vm_demFeSector, all_enty1=c("fedie","fepet"), emi_sectors="trans"), dim=c(3.1,3.2,3.4), na.rm = T)
  p_weights_FEprice_diepet[is.na(p_weights_FEprice_diepet)] <- 0
  p_weights_FEprice_diepet <- p_weights_FEprice_diepet[,getYears(pm_FEPrice),]

  out <- NULL

  ## calculate prices as weighted average prices across markets
  ## FE Transport Prices
  out <- mbind(
    out,
    setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="feelt", emi_sectors = "trans"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
             "Price|Final Energy|Transport|Electricity (US$2005/GJ)"),
    ## in case of transport liquids: calculate weighted average of markets first, then calculate weighted average of fepet/fedie
    setNames( dimSums( p_weights_FEprice_diepet * dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1=c("fepet","fedie"), emi_sectors = "trans"), dim=3.3, na.rm = T), dim=3.1, na.rm = T)*tdptwyr2dpgj,
             "Price|Final Energy|Transport|Liquids (US$2005/GJ)"),
    setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="feh2t", emi_sectors = "trans"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
             "Price|Final Energy|Transport|Hydrogen (US$2005/GJ)")
  )

  if (module2realisation["transport",2] == "edge_esm") {
    out <- mbind(
      out,
      setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fegat", emi_sectors = "trans"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
               "Price|Final Energy|Transport|Gases (US$2005/GJ)"))
  }

  out <- mbind(
    out,
    setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fedie", emi_sectors = "trans"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
             "Price|Final Energy|Transport|Liquids|HDV (US$2005/GJ)"),
    setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fepet", emi_sectors = "trans"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
             "Price|Final Energy|Transport|Liquids|LDV (US$2005/GJ)"))

  ## FE Buildings Prices
  out <- mbind(out,
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="feels", emi_sectors = "build"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Buildings|Electricity (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fegas", emi_sectors = "build"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Buildings|Gases (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="feh2s", emi_sectors = "build"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Buildings|Hydrogen (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fehos", emi_sectors = "build"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Buildings|Liquids (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fehes", emi_sectors = "build"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Buildings|Heat (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fesos", emi_sectors = "build"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Buildings|Solids (US$2005/GJ)")
               )

  ## FE Industry Prices
  out <- mbind(out,
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="feels", emi_sectors = "indst"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Industry|Electricity (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fegas", emi_sectors = "indst"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Industry|Gases (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="feh2s", emi_sectors = "indst"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Industry|Hydrogen (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fehos", emi_sectors = "indst"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Industry|Liquids (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fehes", emi_sectors = "indst"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Industry|Heat (US$2005/GJ)"),
               setNames( dimSums(mselect(p_weights_FEprice_mkt * pm_FEPrice, all_enty1="fesos", emi_sectors = "indst"), dim=3.3, na.rm = T)*tdptwyr2dpgj,
                        "Price|Final Energy|Industry|Solids (US$2005/GJ)")
               )

  ## SE Prices
  out <- mbind(out,
               setNames(mselect(pm_SEPrice, all_enty="seliqfos")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Liquids|Fossil (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="seliqbio")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Liquids|Biomass (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="seliqsyn")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Liquids|Hydrogen (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="sesobio")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Solids|Biomass (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="sesofos")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Solids|Fossil (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="seel")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Electricity (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="seh2")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Hydrogen (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="segabio")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Gases|Biomass (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="segafos")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Gases|Fossil (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="segasyn")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Gases|Hydrogen (US$2005/GJ)"),
               setNames(mselect(pm_SEPrice, all_enty="sehe")*tdptwyr2dpgj,
                        "Price|Secondary Energy|Heat (US$2005/GJ)")
               )


  ## PE Prices
  out <- mbind(out,
               setNames(mselect(p_PEPrice, all_enty="peoil")*tdptwyr2dpgj,
                        "Price|Primary Energy|Oil (US$2005/GJ)"),
               setNames(mselect(p_PEPrice, all_enty="pegas")*tdptwyr2dpgj,
                        "Price|Primary Energy|Gas (US$2005/GJ)"),
               setNames(mselect(p_PEPrice, all_enty="pecoal")*tdptwyr2dpgj,
                        "Price|Primary Energy|Coal (US$2005/GJ)"),
               setNames(mselect(p_PEPrice, all_enty="peur")*tdptwyr2dpgj,
                        "Price|Primary Energy|Nuclear (US$2005/GJ)"),
               ## only modern (ligno-cellulosic) biomass reported
               setNames(mselect(p_PEPrice, all_enty="pebiolc")*tdptwyr2dpgj,
                        "Price|Primary Energy|Biomass|Modern (US$2005/GJ)"),
               setNames(mselect(p_PEPrice, all_enty="pebios")*tdptwyr2dpgj,
                        "Price|Primary Energy|Biomass|1st Generation|Sugar and Starch (US$2005/GJ)"),
               setNames(mselect(p_PEPrice, all_enty="pebios")*tdptwyr2dpgj,
                        "Price|Primary Energy|Biomass|1st Generation|Oil-based (US$2005/GJ)")
               )

  ## apply lowpass filter to receive moving average prices
  out.lowpass <- lowpass(out)
  ## add "Moving Avg" to variable name
  getNames(out.lowpass) <- paste0(substr(getNames(out.lowpass),
                                         1,nchar(getNames(out.lowpass))-13),
                                  "|Moving Avg",
                                  substr(getNames(out.lowpass),
                                         nchar(getNames(out.lowpass))-12,
                                         nchar(getNames(out.lowpass))))

  out <- mbind(out,out.lowpass)

  ## add years before cm_startyear (temporary, can be adapted once prices only calculated after cm_startyear in REMIND code)
  out2 <- new.magpie(getRegions(out), getYears(vm_demFeSector), getNames(out), fill = NA)
  out2[,getYears(out), ] <- out

  out <- out2

  # Calculate and append new variables to magpie object
  # Costs and prices for purpose-grown 2nd gen. bioenergy
  # - Shiftfactor
  # - imported values from MAgPIE reporting
  # - results from emulator based on MAgPIE demand (before main solve)
  # - results from emulator based on MAgPIE demand multiplied with shiftfactor (before main solve)
  # - results from emulator based on REMIND demand (after main solve)
  # - results from emulator based on REMIND demand multiplied with shiftfactor (after main solve)

  out <- mbind(
    out,
    setNames(shift_p, "Internal|Price|Biomass|Shiftfactor ()"),
    setNames(mult_p, "Internal|Price|Biomass|Multfactor ()"),
    setNames(pric_mag * tdptwyr2dpgj, "Internal|Price|Biomass|MAgPIE (US$2005/GJ)"),
    setNames(pric_emu_pre * tdptwyr2dpgj, "Internal|Price|Biomass|Emulator presolve (US$2005/GJ)"),
    setNames(pric_emu_pre_shifted * tdptwyr2dpgj, "Internal|Price|Biomass|Emulator presolve shifted (US$2005/GJ)"),
    setNames(pric_emu * tdptwyr2dpgj, "Internal|Price|Biomass|Emulator shifted (US$2005/GJ)"),
    setNames(pric_emu * bio_tax_factor * tdptwyr2dpgj, "Internal|Price|Biomass|Bioenergy tax (US$2005/GJ)"))


  # energy services
  if (!is.null(esm2macro.m)) {
    out <- mbind(
      out,
      setNames(abs(esm2macro.m[,,name_trsp[2]]/(budget.m+1e-10)) * tdptwyr2dpgj , "Price|Energy Service|Transport nonLDV (US$2005/GJ)"),
      setNames(abs(esm2macro.m[,,name_trsp[1]]/(budget.m+1e-10)) * tdptwyr2dpgj , "Price|Energy Service|Transport LDV (US$2005/GJ)"))
  }


  out <- mbind(out,setNames(abs(pm_pvpRegi / (pm_pvp[,,"good"] + 1e-10)) * 1000 * 12/44, "Price|Carbon (US$2005/t CO2)"))
  out <- mbind(out,setNames(abs(pm_taxCO2eq) * 1000 * 12/44, "Price|Carbon|Guardrail (US$2005/t CO2)"))
  CaptureBal_tmp <- new.magpie(getRegions(out), getYears(out), fill = NA)
  CaptureBal_tmp[,getYears(balcapture.m),] <- balcapture.m
  out <- mbind(out, setNames(CaptureBal_tmp / (budget.m+1e-10) / 3.66 * 1e3,
               "Price|Carbon|Captured (US$2005/t CO2)"))

  if (is.null(regionSubsetList$EUR)) {
    out <- mbind(out,setNames(pm_taxCO2eq * 1000 * 12/44, "Price|Carbon|EU-wide Regulation For All Sectors (US$2005/t CO2)"))
  } else {
    co2EUprice <- pm_taxCO2eq * 1000 * 12/44
    co2EUprice[getRegions(pm_taxCO2eq)[!getRegions(pm_taxCO2eq) %in% regionSubsetList$EUR],,] <- 0
    priceReg <- regionSubsetList$EUR[!regionSubsetList$EUR %in% c("DEU","FRA","EUC","EUW")][1] #select region to define EU price (excluding Germany and France)
    for (r in regionSubsetList$EUR){
      co2EUprice[r,,] <- as.vector(co2EUprice[priceReg,,])
    }
    out <- mbind(out,setNames(co2EUprice, "Price|Carbon|EU-wide Regulation For All Sectors (US$2005/t CO2)"))
  }

  if (!is.null(pm_taxemiMkt)) {
    out <- mbind(out,setNames(pm_taxemiMkt[,,"ETS"] * 1000 * 12/44, "Price|Carbon|ETS (US$2005/t CO2)"))
    out <- mbind(out,setNames(pm_taxemiMkt[,,"ES"] * 1000 * 12/44, "Price|Carbon|ESR (US$2005/t CO2)"))
  }

  if (!is.null(pm_taxCO2eqSCC)) {
      out <- mbind(out,setNames(abs(pm_taxCO2eqSCC) * 1000 * 12/44, "Price|Carbon|SCC (US$2005/t CO2)"))
  }

  out <- mbind(out,setNames(out[,,"Price|Carbon (US$2005/t CO2)"] * s_GWP_N2O, "Price|N2O (US$2005/t N2O)"))
  out <- mbind(out,setNames(out[,,"Price|Carbon (US$2005/t CO2)"] * s_GWP_CH4, "Price|CH4 (US$2005/t CH4)"))


  # ---- mapping of weights for the variables for global aggregation ----
  int2ext <- c(
    "Price|Primary Energy|Biomass|Modern (US$2005/GJ)"                = "PE|Biomass|Modern (EJ/yr)",
    "Price|Primary Energy|Oil (US$2005/GJ)"      = "PE|+|Oil (EJ/yr)",
    "Price|Primary Energy|Gas (US$2005/GJ)"      = "PE|+|Gas (EJ/yr)",
    "Price|Primary Energy|Coal (US$2005/GJ)"     = "PE|+|Coal (EJ/yr)",
    "Price|Primary Energy|Nuclear (US$2005/GJ)"     = "PE|+|Nuclear (EJ/yr)",
    "Price|Primary Energy|Biomass|1st Generation|Sugar and Starch (US$2005/GJ)" = "PE|Biomass|1st Generation (EJ/yr)",
    "Price|Primary Energy|Biomass|1st Generation|Oil-based (US$2005/GJ)" = "PE|Biomass|1st Generation (EJ/yr)",

    "Internal|Price|Biomass|Emulator presolve (US$2005/GJ)"            = "Primary Energy Production|Biomass|Energy Crops MAgPIE (EJ/yr)",
    "Internal|Price|Biomass|Emulator presolve shifted (US$2005/GJ)"    = "Primary Energy Production|Biomass|Energy Crops MAgPIE (EJ/yr)",
    "Internal|Price|Biomass|Emulator shifted (US$2005/GJ)"             = "Primary Energy Production|Biomass|Energy Crops (EJ/yr)",
    "Internal|Price|Biomass|MAgPIE (US$2005/GJ)"                       = "Primary Energy Production|Biomass|Energy Crops MAgPIE (EJ/yr)",
    "Internal|Price|Biomass|Bioenergy tax (US$2005/GJ)"                = "Primary Energy Production|Biomass|Energy Crops (EJ/yr)",
    "Price|N2O (US$2005/t N2O)"                               = "Emi|N2O (kt N2O/yr)",
    "Price|CH4 (US$2005/t CH4)"                               = "Emi|CH4 (Mt CH4/yr)",
    "Price|Secondary Energy|Electricity (US$2005/GJ)"            = "SE|Electricity (EJ/yr)",
    "Price|Secondary Energy|Hydrogen (US$2005/GJ)"            = "SE|Hydrogen (EJ/yr)",
    "Price|Secondary Energy|Heat (US$2005/GJ)"                = "SE|Heat (EJ/yr)",
    "Price|Secondary Energy|Solids|Biomass (US$2005/GJ)"            = "SE|Solids|Biomass (EJ/yr)",
    "Price|Secondary Energy|Liquids|Biomass (US$2005/GJ)"             = "SE|Liquids|Biomass (EJ/yr)",
    "Price|Secondary Energy|Gases|Biomass (US$2005/GJ)"             = "SE|Gases|Biomass (EJ/yr)",
    "Price|Secondary Energy|Solids|Fossil (US$2005/GJ)"            = "SE|Solids|Coal (EJ/yr)",
    "Price|Secondary Energy|Liquids|Fossil (US$2005/GJ)"             = "SE|Liquids|Oil (EJ/yr)",
    "Price|Secondary Energy|Gases|Fossil (US$2005/GJ)"             = "SE|Gases|Fossil (EJ/yr)",
    "Price|Secondary Energy|Liquids|Hydrogen (US$2005/GJ)"             = "SE|Liquids|Hydrogen (EJ/yr)",
    "Price|Secondary Energy|Gases|Hydrogen (US$2005/GJ)"             = "SE|Gases|Hydrogen (EJ/yr)",
    "Price|Carbon|ETS (US$2005/t CO2)"                        = "Emi|GHG|++|ETS (Mt CO2eq/yr)",
    "Price|Carbon|ESR (US$2005/t CO2)"                        = "Emi|GHG|++|ESR (Mt CO2eq/yr)"
    )

  if (!is.null(esm2macro.m)) {
    int2ext <- c(int2ext,
                 "Price|Energy Service|Transport LDV (US$2005/GJ)"         = "CES_input|fepet (EJ/yr)",  ## TODO: check units
                 "Price|Energy Service|Transport nonLDV (US$2005/GJ)"      = "CES_input|fedie (EJ/yr)"  ## TODO: check units
    )
  }

  if (all(cm_emiscen == 9)) int2ext <- c(int2ext, c( "Price|Carbon (US$2005/t CO2)"  = "Internal|Emi|GHG|Emissions to which global CO2 tax is applied (Mt CO2eq/yr)"))


  ## weights definition for region aggregtation
  int2ext <- c(int2ext,

               ## transport prices
               "Price|Final Energy|Transport|Electricity (US$2005/GJ)"       = "FE|Transport|+|Electricity (EJ/yr)",
               "Price|Final Energy|Transport|Liquids (US$2005/GJ)"       = "FE|Transport|+|Liquids (EJ/yr)",
               "Price|Final Energy|Transport|Hydrogen (US$2005/GJ)"       = "FE|Transport|+|Hydrogen (EJ/yr)",

               ## buildings prices
               "Price|Final Energy|Buildings|Electricity (US$2005/GJ)"       = "FE|Buildings|+|Electricity (EJ/yr)",
               "Price|Final Energy|Buildings|Liquids (US$2005/GJ)"       = "FE|Buildings|+|Liquids (EJ/yr)",
               "Price|Final Energy|Buildings|Gases (US$2005/GJ)"       = "FE|Buildings|+|Gases (EJ/yr)",
               "Price|Final Energy|Buildings|Hydrogen (US$2005/GJ)"       = "FE|Buildings|+|Hydrogen (EJ/yr)",
               "Price|Final Energy|Buildings|Heat (US$2005/GJ)"       = "FE|Buildings|+|Heat (EJ/yr)",
               "Price|Final Energy|Buildings|Solids (US$2005/GJ)"       = "FE|Buildings|+|Solids (EJ/yr)",

               ## industry prices
               "Price|Final Energy|Industry|Electricity (US$2005/GJ)"       = "FE|Industry|+|Electricity (EJ/yr)",
               "Price|Final Energy|Industry|Liquids (US$2005/GJ)"       = "FE|Industry|+|Liquids (EJ/yr)",
               "Price|Final Energy|Industry|Gases (US$2005/GJ)"       = "FE|Industry|+|Gases (EJ/yr)",
               "Price|Final Energy|Industry|Hydrogen (US$2005/GJ)"       = "FE|Industry|+|Hydrogen (EJ/yr)",
               "Price|Final Energy|Industry|Heat (US$2005/GJ)"       = "FE|Industry|+|Heat (EJ/yr)",
               "Price|Final Energy|Industry|Solids (US$2005/GJ)"       = "FE|Industry|+|Solids (EJ/yr)"
               )
  
  
  
  # transport-specific mappings depending on realization
  
  if (module2realisation["transport",2] == "complex") {
    int2ext <- c(int2ext,
                 "Price|Final Energy|Transport|Liquids|HDV (US$2005/GJ)"       = "FE|Transport|non-LDV|+|Liquids (EJ/yr)",
                 "Price|Final Energy|Transport|Liquids|LDV (US$2005/GJ)"       = "FE|Transport|LDV|+|Liquids (EJ/yr)")
  } else if (module2realisation["transport",2] == "edge_esm") {
    int2ext <- c(int2ext,
                 "Price|Final Energy|Transport|Liquids|HDV (US$2005/GJ)"       = "FE|Transport|Diesel Liquids (EJ/yr)",
                 "Price|Final Energy|Transport|Liquids|LDV (US$2005/GJ)"       = "FE|Transport|Pass|Liquids (EJ/yr)",
                 "Price|Final Energy|Transport|Gases (US$2005/GJ)"       = "FE|Transport|+|Gases (EJ/yr)")          
  }
  
 

  ## moving averages
  avgs <- grep("Moving Avg", getNames(out), value=TRUE)
  int2ext <- c(int2ext, stats::setNames(int2ext[gsub("\\|Moving Avg", "", avgs)], avgs))

  ## bind to output object
  if(is.null(output)){
    output <- reportPE(gdx,regionSubsetList = regionSubsetList,t = t)
    output <- mbind(output,reportSE(gdx,regionSubsetList = regionSubsetList,t = t))
    output <- mbind(output,reportFE(gdx,regionSubsetList = regionSubsetList,t = t))
    output <- mbind(output,reportEmi(gdx,regionSubsetList = regionSubsetList,t = t))
    output <- mbind(output,reportExtraction(gdx,regionSubsetList = regionSubsetList,t = t))
    output <- mbind(output,reportMacroEconomy(gdx,regionSubsetList = regionSubsetList,t = t)[,getYears(output),])
  }

  output[is.na(output)] <- 0  # substitute na by 0

  # add global prices
  map <- data.frame(region=getRegions(out),world="GLO",stringsAsFactors=FALSE)
  tmp_GLO <- new.magpie("GLO",getYears(out),magclass::getNames(out),fill=0)

  for (i2e in names(int2ext)){
    tmp_GLO["GLO",,i2e] <- speed_aggregate(out[,,i2e],map,weight=output[map$region,,int2ext[i2e]])
    for(t in getYears(out)){
      if(all(output[map$region,t,int2ext[i2e]]==0)){
        tmp_GLO["GLO",t,i2e] <- NA
      }
    }
  }
  out <- mbind(out,tmp_GLO)

  # add other region aggregations
  if (!is.null(regionSubsetList)){
    tmp_RegAgg <- new.magpie(names(regionSubsetList),getYears(out),magclass::getNames(out),fill=0)
    for(region in names(regionSubsetList)){
      tmp_RegAgg_ie2 <- do.call("mbind",lapply(names(int2ext), function(i2e) {
        map <- data.frame(region=regionSubsetList[[region]],parentRegion=region,stringsAsFactors=FALSE)
        result <- speed_aggregate(out[regionSubsetList[[region]],,i2e],map,weight=output[regionSubsetList[[region]],,int2ext[i2e]])
        getItems(result, dim = 1) <- region
        for(t in getYears(out)){
          if(all(output[regionSubsetList[[region]],t,int2ext[i2e]]==0)){
            result[region,t,i2e] <- NA
          }
        }
        return(result)
      }))
      tmp_RegAgg[region,,names(int2ext)] <- tmp_RegAgg_ie2[region,,names(int2ext)]
    }
    out <- mbind(out, tmp_RegAgg)
  }

  out[is.na(out)] <- 0  # out is NA if weight is zero for all regions within the GLO or the specific region aggregation. Therefore, we replace all NAs with zeros.

  # prices that are same for all regions, including GLO
  glob_price <- new.magpie(getRegions(out),getYears(out),fill=0)
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"peur"]*1000
  out <- mbind(out,setNames(glob_price,                             "PVP1|Uranium (billionDpktU)"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"peoil"]*1000
  out <- mbind(out,setNames(glob_price,                             "PVP1|Oil (billionDpTWyr)"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"pegas"]*1000
  out <- mbind(out,setNames(glob_price,                             "PVP1|Gas (billionDpTWyr)"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"pecoal"]*1000
  out <- mbind(out,setNames(glob_price,                             "PVP1|Coal (billionDpTWyr)"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"pebiolc"]*1000
  out <- mbind(out,setNames(glob_price,                             "PVP1|Biomass (billionDpTWyr)"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"good"]*1000
  out <- mbind(out,setNames(glob_price,                             "PVP2|Good ()"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"perm"]
  out <- mbind(out,setNames(glob_price,                             "PVP3|Permit ()"))

  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"peur"]/pm_pvp[,,"good"] * tdptwyr2dpgj
  out <- mbind(out,setNames(glob_price,                                       "Price|Uranium|World Market (US$2005/GJ)"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"peoil"]/pm_pvp[,,"good"] * tdptwyr2dpgj
  out <- mbind(out,setNames(glob_price,                                       "Price|Oil|World Market (US$2005/GJ)"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"pegas"]/pm_pvp[,,"good"] * tdptwyr2dpgj
  out <- mbind(out,setNames(glob_price,                                       "Price|Gas|World Market (US$2005/GJ)"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"pecoal"]/pm_pvp[,,"good"] * tdptwyr2dpgj
  out <- mbind(out,setNames(glob_price,                                       "Price|Coal|World Market (US$2005/GJ)"))
  for(i in getRegions(out)) glob_price[i,,] <- pm_pvp[,,"pebiolc"]/pm_pvp[,,"good"] * tdptwyr2dpgj
  out <- mbind(out,setNames(glob_price,                                       "Price|Biomass|World Market (US$2005/GJ)"))

  ## special global prices

  #AJS calc global carbon price as average over regional pm_pvpRegi's, weighted by total emissions.
  regi_on_gdx <- unique(readGDX(gdx, name = "regi2iso")[,1])

  out["GLO",,"Price|Carbon (US$2005/t CO2)"] <-
    dimSums( pm_pvpRegi[regi_on_gdx,,"perm"] * output[regi_on_gdx,,"Internal|Emi|GHG|Emissions to which global CO2 tax is applied (Mt CO2eq/yr)"],dim=1 ) /
    dimSums(output[regi_on_gdx,,"Internal|Emi|GHG|Emissions to which global CO2 tax is applied (Mt CO2eq/yr)"],dim=1) /
    (pm_pvp[1,,"good"] + 1e-10) * 1000*12/44

  # add other region aggregations carbon price as average over regional pm_pvpRegi's, weighted by total emissions.
  if (!is.null(regionSubsetList)){
    for(region in names(regionSubsetList)){
      out[region,,"Price|Carbon (US$2005/t CO2)"] <- dimSums( pm_pvpRegi[regionSubsetList[[region]],,"perm"] * output[regionSubsetList[[region]],,"Internal|Emi|GHG|Emissions to which global CO2 tax is applied (Mt CO2eq/yr)"],dim=1 ) /
        dimSums(output[regionSubsetList[[region]],,"Internal|Emi|GHG|Emissions to which global CO2 tax is applied (Mt CO2eq/yr)"],dim=1) /
        (pm_pvp[1,,"good"] + 1e-10) * 1000*12/44;
    }
  }

  ## not meaningful global prices set to NA
  out["GLO",,"Internal|Price|Biomass|Shiftfactor ()"] <- NA

  if (!is.null(regionSubsetList$EUR))
    out["EUR",,"Price|Carbon|EU-wide Regulation For All Sectors (US$2005/t CO2)"] <- as.vector(co2EUprice[priceReg,,])

  ## not meaningful region aggregation prices set to NA
  if (!is.null(regionSubsetList)){
    for(region in names(regionSubsetList)){
      out[region,,"Internal|Price|Biomass|Shiftfactor ()"] <- NA
    }
  }

  # comment out this section for now as errors, debug this section if needed
  # # ---- debug information for industry/subsectors ----
  # if ('subsectors' == indu_mod & !is.null(q37_limit_secondary_steel_share.m)) {
  #   
  #   t <- getYears(budget.m)
  #   
  #   .x <- q37_limit_secondary_steel_share.m[, t,] / budget.m
  #   .x <- mbind(.x, calc_regionSubset_sums(.x, regionSubsetList))
  #   
  # 
  #   tmp2 <- mbind(
  #     # fake some GLO data
  #     setNames(
  #       mbind(.x, dimSums(.x * NA, dim = 1)),
  #       'Debug|Industry|Secondary Steel Premium (US$2005)'),
  # 
  #     mbind(
  #       lapply(
  #         list(
  #           c('ue_industry',        '',                 'arbitrary unit', 1),
  #           c('ue_cement',          '|Cement',          't cement',       1e3),
  #           c('ue_chemicals',       '|Chemicals',       'arbitrary unit', 1),
  #           c('ue_steel',           '|Steel',           't Steel',        1e3),
  #           c('ue_steel_primary',   '|Steel|Primary',   't Steel',        1e3),
  #           c('ue_steel_secondary', '|Steel|Secondary', 't Steel',        1e3),
  #           c('ue_otherInd',        '|other',           'arbitrary unit', 1)),
  #         function(x) {
  #           setNames(
  #             ( out[,,paste0('Price|CES_input|', x[1], ' ('), pmatch = 'left']
  #               * as.numeric(x[4])
  #             ),
  #             paste0('Debug|Price|Industry', x[2], ' (US$2005/', x[3], ')'))
  #         })
  #     )
  #   )
  # 
  #   out <- mbind(out, tmp2)
  # }

  return(out)
}
